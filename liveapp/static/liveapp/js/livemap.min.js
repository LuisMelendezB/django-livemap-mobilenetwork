const ajaxUrls={nodes:"/livemap/ajax_markers/",kpis:"/livemap/ajax_kpis/"},initialMap={lat:"29.7433056",lng:"-95.2331944",zoom:13},polygonsProperties={strokeColor:"#000000",strokeOpacity:1,strokeWeight:1,fillOpacity:.8},nodeMarkerProperties={label:{fontWeight:"bold",color:"#000000",strokeColor:"#000000",strokeWeight:10},icon:{url:"/static/liveapp/img/nodeMarker.svg",scaledSizeX:20,scaledSizeY:20,labelOriginX:10,labelOriginY:-10,fontSize:"8px"}},clustersProperties={imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",zoomOnClick:!0,gridSize:110};function getClickText(e,o,t){return clickText="<small>S:"+e+" - B:"+o+': </small><font color="black"><b>'+t+"</b></font>",clickText}var csrf_token=document.getElementsByName("csrfmiddlewaretoken")[0],markers_array=[];const nodes={names:[],codes:[]},rangeDates={min:null,max:null,selected:null};var map,kpisSpecs=null,markerCluster=null,clustered_markers=null,promiseNodes=getJsonNodes(),ajaxreq=null,auto=!1,infoWindow=null,ignored_markers=[],kpi="availability",prevKpi=kpi,polygons_base=[],arrayKpis=[];function getJsonNodes(){return call_blockui(),new Promise(function(o,t){$.ajax({type:"POST",url:ajaxUrls.nodes,contentType:"application/json; charset=utf-8",data:JSON.stringify({get:"nodes"}),dataType:"json",headers:{"X-CSRFToken":csrf_token.value},success:function(e){receivedJsonNodes=JSON.parse(e),rangeDates.max=receivedJsonNodes.slice(-1)[0].maxDate,rangeDates.min=receivedJsonNodes.slice(-1)[0].minDate,rangeDates.selected=rangeDates.max,kpisSpecs=receivedJsonNodes.slice(-1)[0].kpisSpecs,receivedJsonNodes=receivedJsonNodes.slice(0,-1),"FAILED"==receivedJsonNodes.status?window.alert(receivedJsonNodes.reason):o(receivedJsonNodes)},failure:function(e){console.log("not completed ajax"),receivedJsonNodes=null,t("promise fail")},complete:function(e){$.unblockUI(),console.log("completed ajax markers"),init_inputs(),o("promise ok")}})})}function addMarkers(e){for(node in e){nodes.names.push(e[node].name),nodes.codes.push(e[node].code);var o={lat:parseFloat(e[node].latitude),lng:parseFloat(e[node].longitude)},o=new google.maps.Marker({position:o,title:e[node].code,label:{text:e[node].name,fontWeight:nodeMarkerProperties.label.fontWeight,color:nodeMarkerProperties.label.color,strokeColor:nodeMarkerProperties.label.strokeColor,strokeWeight:nodeMarkerProperties.label.strokeWeight},icon:{url:nodeMarkerProperties.icon.url,scaledSize:new google.maps.Size(nodeMarkerProperties.icon.scaledSizeX,nodeMarkerProperties.icon.scaledSizeY),labelOrigin:new google.maps.Point(nodeMarkerProperties.icon.labelOriginX,nodeMarkerProperties.icon.labelOriginY),fontSize:nodeMarkerProperties.icon.fontSize}});markers_array.push(o)}}function map_first_load(){return new Promise(function(e,o){infoWindow=new google.maps.InfoWindow,google.maps.event.addListener(map,"idle",function(){null!=ajaxreq&&(ajaxreq.abort(),map.setOptions({gestureHandling:"none",zoomControl:!1})),showVisibleMarkers();var e=get_nodesToSend();jsonToSend={nodesToSend:e},1==auto?(polygons_base=delete_polygons(polygons_base),send_markers(jsonToSend)):map.setOptions({gestureHandling:"greedy",zoomControl:!0})}),null!=infoWindow?(e("map loaded"),console.log(infoWindow)):o("map not loaded")})}function showVisibleMarkers(){let o=[],t=[];for(let e=0;e<markers_array.length;e++)!0===map.getBounds().contains(markers_array[e].getPosition())?(markers_array[e].setMap(null),markers_array[e].setMap(map),o.push(markers_array[e]),!1===t.includes(markers_array[e])&&t.push(markers_array[e])):(!0===t.includes(markers_array[e])&&t.pop(markers_array[e]),markers_array[e].setMap(null));markerCluster&&(markerCluster.clearMarkers(),markerCluster.addMarkers(o),clustered_markers=markerCluster.getMarkers())}function get_nodesToSend(){for(var e=[],o=markerCluster.getClusters(),t=0;t<o.length;t++)null!=o[t]&&null!=o[t].markers_&&1==o[t].markers_.length&&e.push(o[t].markers_[0].title);for(var n="",a=[],t=0;t<e.length;t++)n=n+","+e[t],ignored_markers.includes(e[t])||a.push(e[t]);return a}function send_markers(e){e.kpi=kpi,e.date=rangeDates.selected,ajaxreq=$.ajax({type:"POST",url:ajaxUrls.kpis,contentType:"application/json; charset=utf-8",data:JSON.stringify(e),dataType:"json",headers:{"X-CSRFToken":csrf_token.value},success:function(e){e=JSON.parse(e);map.setOptions({gestureHandling:"greedy",zoomControl:!0}),null==e.no_data&&(polygons_base=createPolygons(e))},failure:function(e){console.log("not completed sendmarkers"),map.setOptions({gestureHandling:"greedy",zoomControl:!0})}})}function createPolygons(t){let n=[];for(var a in t)for(var r in t[a])for(var s in t[a][r]){let e=t[a][r][s].kpiValue,o=(i=t[a][r][s].coordinates,l=t[a][r][s].color,new google.maps.Polygon({paths:i,fillColor:l,strokeColor:polygonsProperties.strokeColor,strokeOpacity:polygonsProperties.strokeOpacity,strokeWeight:polygonsProperties.strokeWeight,fillOpacity:polygonsProperties.fillOpacity}));o.clickText=getClickText(r,s,e.toString()),n.push(o)}var i,l;for(let e=0;e<n.length;e++)n[e].setMap(map),function(t){google.maps.event.addListener(t,"click",function(e){var o="<div>"+t.clickText+"</div>";infoWindow.setContent(o),infoWindow.setPosition(e.latLng),infoWindow.open(map)})}(n[e]);return n}function pseudo_idle_map(){null!=ajaxreq&&(ajaxreq.abort(),map.setOptions({gestureHandling:"none",zoomControl:!1})),showVisibleMarkers();var e=get_nodesToSend();jsonToSend={nodesToSend:e},polygons_base=delete_polygons(polygons_base),send_markers(jsonToSend)}function myMap(){var e=document.getElementById("map"),o=(new google.maps.InfoWindow,{center:new google.maps.LatLng(initialMap.lat,initialMap.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,gestureHandling:"greedy",zoom:initialMap.zoom});map=new google.maps.Map(e,o);new MeasureTool(map,{showSegmentLength:!0,tooltip:!1,unit:MeasureTool.UnitTypeId.METRIC});google.maps.event.addListener(map,"click",function(e){$("#add_custom_marker").is(":checked")&&placeMarker(e.latLng)});var t=new google.maps.drawing.DrawingManager({drawingMode:google.maps.drawing.OverlayType.MARKER,drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["marker","polygon","polyline","rectangle"]},circleOptions:{fillColor:"#ffff00",fillOpacity:.8,strokeWeight:5,clickable:!1,editable:!0,zIndex:1}});t.setMap(map),t.setDrawingMode(null),google.maps.event.addListener(t,"overlaycomplete",function(e){t.setDrawingMode(null),e.overlay.addListener("click",function(){e.overlay.setMap(null),$("#dialog").dialog("close")}),e.overlay.addListener("rightclick",function(){add_dialog(e)})})}function delete_polygons(e){for(var o=0;o<e.length;o++)e[o].setMap(null);return e=[]}function placeMarker(e){var o=new google.maps.Marker({position:e,map:map});o.addListener("click",function(){o.setMap(null)})}function call_blockui(){$.blockUI({message:$("#displayBox"),css:{border:"none",backgroundColor:"transparent",textAlign:"center"}}),setTimeout($.unblockUI,3e4)}function init_inputs(){$("#input_nombre").autocomplete({source:nodes.names,select:function(e,o){return $("#input_nombre").val(o.item.label),center_to_name(document.getElementById("input_nombre").value),!1}}),$("#input_propiedad").autocomplete({source:nodes.codes,select:function(e,o){return $("#input_propiedad").val(o.item.label),center_to_site(document.getElementById("input_propiedad").value),!1}})}function center_to_site(e){for(var o=markers_array.length,t=0;t<o;t++)if(markers_array[t].title==e){var n=markers_array[t].position;map.setCenter(n),map.setZoom(16),document.getElementById("input_nombre").value=markers_array[t].label.text;break}}function center_to_name(e){for(var o=markers_array.length,t=0;t<o;t++)if(markers_array[t].label.text==e){var n=markers_array[t].position;map.setCenter(n),map.setZoom(16),document.getElementById("input_propiedad").value=markers_array[t].title;break}}function add_legends(e,o){e=document.getElementById(e);map.controls[google.maps.ControlPosition[o]].push(e),e.style.display="inherit"}function remove_legends(e,o){e=document.getElementById(e);e.style.display="none",map.controls[google.maps.ControlPosition[o]].pop(e),$("#kpi_legends").append(e)}function createLegendsDOMSorted(){var e=document.getElementsByTagName("body")[0];for(kpiName in kpisSpecs){var o=document.createElement("div"),t=document.createElement("table");o.classList.add("kpi-legends"),t.classList.add("table-legends"),o.setAttribute("id","mapLegend_"+kpiName);var n=document.createElement("tbody"),a=document.createElement("tr"),r=document.createElement("td");r.style.backgroundColor="gray";var s=document.createTextNode(kpiName);for(pairData in r.appendChild(s),a.appendChild(r),n.appendChild(a),kpisSpecs[kpiName]){var i=document.createElement("tr"),l=document.createElement("td");l.classList.add("td-legends");var d=document.createTextNode(kpisSpecs[kpiName][pairData][0]);l.style.backgroundColor=kpisSpecs[kpiName][pairData][1],l.appendChild(d),i.appendChild(l),n.appendChild(i)}s=document.createElement("tr"),r=document.createElement("td");r.classList.add("td-legends");a=document.createTextNode("-1");r.appendChild(a),s.appendChild(r),n.appendChild(s),t.appendChild(n),o.appendChild(t),e.appendChild(o)}}function createLegendsDOM(){var e=document.getElementsByTagName("body")[0];for(kpiSpec in kpisSpecs){var o=document.createElement("div"),t=document.createElement("table");o.classList.add("kpi-legends"),t.classList.add("table-legends"),o.setAttribute("id","mapLegend_"+kpiSpec);var n=document.createElement("tbody"),a=document.createElement("tr"),r=document.createElement("td");r.style.backgroundColor="gray";var s=document.createTextNode(kpiSpec);for(range in r.appendChild(s),a.appendChild(r),n.appendChild(a),kpisSpecs[kpiSpec]){var i=document.createElement("tr"),l=document.createElement("td");l.classList.add("td-legends");var d=document.createTextNode(range);l.style.backgroundColor=kpisSpecs[kpiSpec][range],l.appendChild(d),i.appendChild(l),n.appendChild(i)}s=document.createElement("tr"),r=document.createElement("td");r.classList.add("td-legends");a=document.createTextNode("-1");r.appendChild(a),s.appendChild(r),n.appendChild(s),t.appendChild(n),o.appendChild(t),e.appendChild(o)}}function init_datepicker(){$("#datepicker-s").datepicker({firstDay:1,showWeek:!0,showOtherMonths:!0,dateFormat:"yy-mm-dd",onSelect:function(){rangeDates.selected=$("#datepicker-s").val(),1==document.getElementById("autoCheck").checked&&pseudo_idle_map()}}),$("#datepicker-s").datepicker("setDate",rangeDates.selected)}promiseNodes.then(function(e){$(document).ready(function(){addMarkers(receivedJsonNodes),markerCluster=new MarkerClusterer(map,markers_array,{imagePath:clustersProperties.imagePath,zoomOnClick:clustersProperties.zoomOnClick,gridSize:clustersProperties.gridSize}),firstLoad=map_first_load(),firstLoad.then(function(e){createLegendsDOMSorted(),createLegendsDOM(),add_legends("mapLegend_auto","BOTTOM_CENTER"),add_legends("mapLegend_availability","LEFT_CENTER")}),init_datepicker()})},function(e){console.log(e)}),$(document).ready(function(){document.getElementById("autoCheck").addEventListener("change",function(){1==document.getElementById("autoCheck").checked?(document.getElementById("div-check").className="custom-control custom-switch div-plot",auto=!0,pseudo_idle_map()):(auto=!1,document.getElementById("div-check").className="custom-control custom-switch div-plot-cn")})}),document.getElementById("kpi").addEventListener("change",function(){prevKpi=kpi,kpi=$("#kpi option:selected").val(),1==document.getElementById("autoCheck").checked&&pseudo_idle_map(),remove_legends("mapLegend_"+prevKpi,"LEFT_CENTER"),add_legends("mapLegend_"+kpi,"LEFT_CENTER")});